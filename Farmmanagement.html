<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Farm Management System</title>
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      overflow-x: hidden;
    }
    
    .container { 
      max-width: 1400px; 
      margin: auto; 
      padding: 20px;
      position: relative;
    }
    
    .header { 
      text-align: center; 
      margin-bottom: 40px; 
      color: white;
      animation: fadeInDown 1s ease-out;
    }
    
    .header h1 {
      font-size: 3rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    
    .nav-tabs { 
      display: flex; 
      justify-content: center; 
      margin-bottom: 30px; 
      background: rgba(255,255,255,0.1); 
      border-radius: 50px; 
      padding: 5px; 
      backdrop-filter: blur(10px);
      animation: slideInUp 0.8s ease-out;
    }
    
    .nav-tab { 
      padding: 15px 30px; 
      background: transparent; 
      border: none; 
      color: white; 
      cursor: pointer; 
      border-radius: 25px; 
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .nav-tab:hover::before {
      left: 100%;
    }
    
    .nav-tab.active { 
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
    }
    
    .tab-content { 
      display: none; 
      background: white; 
      padding: 40px; 
      border-radius: 25px; 
      margin-top: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-out;
    }
    
    .tab-content.active { display: block;}
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    
    .stat-card h3 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .stat-card p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .form-section h3 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .form-group { margin-bottom: 20px;}
    
    .form-group label { 
      display: block; 
      margin-bottom: 8px; 
      font-weight: 600;
      color: #555;
    }
    
    .form-group input, 
    .form-group textarea, 
    .form-group select {
      width: 100%; 
      padding: 15px; 
      border: 2px solid #e0e0e0; 
      border-radius: 10px; 
      font-size: 16px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn { 
      padding: 15px 30px; 
      border: none; 
      border-radius: 10px; 
      font-weight: 600; 
      cursor: pointer; 
      margin-right: 10px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transition: width 0.3s ease, height 0.3s ease;
      transform: translate(-50%, -50%);
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn-danger { 
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    }
    
    .search-filter-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .search-filter-grid {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: end;
    }
    
    .search-input {
      position: relative;
    }
    
    .search-input input {
      padding-left: 45px;
    }
    
    .search-input::before {
      content: 'üîç';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }
    
    .farm-list, .crop-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
      gap: 25px; 
      margin-top: 25px;
    }
    
    .farm-card, .crop-card { 
      background: white; 
      padding: 25px; 
      border-radius: 20px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .farm-card::before,
    .crop-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .farm-card:hover, .crop-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #333;
    }
    
    .card-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-active {
      background: #d4edda;
      color: #155724;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }
    
    .card-info {
      margin-bottom: 20px;
    }
    
    .card-info p {
      margin-bottom: 8px;
      color: #666;
    }
    
    .card-info strong {
      color: #333;
    }
    
    .card-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .card-actions .btn {
      padding: 8px 16px;
      font-size: 0.9rem;
      margin-right: 0;
    }
    
    .alert { 
      margin: 20px 0; 
      padding: 18px; 
      border-radius: 12px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }
    
    .alert-success { 
      background: #d4edda; 
      color: #155724;
      border-left-color: #28a745;
    }
    
    .alert-error { 
      background: #f8d7da; 
      color: #721c24;
      border-left-color: #dc3545;
    }
    
    .alert-info {
      background: #cce7ff;
      color: #004085;
      border-left-color: #007bff;
    }
    
    .loading { 
      text-align: center; 
      color: #667eea;
      font-size: 1.1rem;
      padding: 40px;
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #667eea;
      border-top: 3px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
    }
    
    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }
    
    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideInUp 0.3s ease-out;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }
    
    .weather-widget {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
    }
    
    .weather-widget h3 {
      margin-bottom: 10px;
    }
    
    .notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      max-width: 300px;
    }
    
    .notification {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
      animation: slideInRight 0.3s ease-out;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) { 
      .nav-tabs {
        flex-direction: column;
        gap: 10px;
      }
      
      .nav-tab {
        width: 100%;
        text-align: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .search-filter-grid {
        grid-template-columns: 1fr;
      }
      
      .farm-list, .crop-list {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .tab-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üåæ Smart Farm Management System</h1>
      <p>Qu·∫£n l√Ω n√¥ng tr·∫°i v√† c√¢y tr·ªìng th√¥ng minh</p>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
      <button class="nav-tab" onclick="showTab('farms', event)">üè° N√¥ng tr·∫°i</button>
      <button class="nav-tab" onclick="showTab('crops', event)">üå± C√¢y tr·ªìng</button>
      <button class="nav-tab" onclick="showTab('analytics', event)">üìà Th·ªëng k√™</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <h2>Dashboard T·ªïng quan</h2>
      
      <div class="weather-widget">
        <h3>üå§Ô∏è Th·ªùi ti·∫øt h√¥m nay</h3>
        <p>Nhi·ªát ƒë·ªô: 28¬∞C | ƒê·ªô ·∫©m: 75% | Gi√≥: 5 km/h</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="total-farms">0</h3>
          <p>T·ªïng s·ªë n√¥ng tr·∫°i</p>
        </div>
        <div class="stat-card">
          <h3 id="total-crops">0</h3>
          <p>T·ªïng s·ªë lo·∫°i c√¢y tr·ªìng</p>
        </div>
        <div class="stat-card">
          <h3 id="total-area">0</h3>
          <p>T·ªïng di·ªán t√≠ch (ha)</p>
        </div>
        <div class="stat-card">
          <h3 id="active-farms">0</h3>
          <p>N√¥ng tr·∫°i ƒëang ho·∫°t ƒë·ªông</p>
        </div>
      </div>

      <div class="form-section">
        <h3>üîî Th√¥ng b√°o g·∫ßn ƒë√¢y</h3>
        <div id="recent-notifications">
          <p>Ch∆∞a c√≥ th√¥ng b√°o m·ªõi</p>
        </div>
      </div>
    </div>

    <!-- Tab Qu·∫£n l√Ω N√¥ng tr·∫°i -->
    <div id="farms" class="tab-content">
      <h2>Qu·∫£n l√Ω N√¥ng tr·∫°i</h2>
      
      <div class="search-filter-section">
        <div class="search-filter-grid">
          <div class="search-input">
            <input type="text" id="farm-search" placeholder="T√¨m ki·∫øm n√¥ng tr·∫°i..." onkeyup="searchFarms()">
          </div>
          <select id="farm-filter" onchange="filterFarms()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
            <option value="inactive">Ng∆∞ng ho·∫°t ƒë·ªông</option>
          </select>
          <button class="btn btn-primary" onclick="toggleFarmForm()">+ Th√™m n√¥ng tr·∫°i</button>
        </div>
      </div>

      <div id="farm-form-section" class="form-section" style="display: none;">
        <h3>Th√¥ng tin n√¥ng tr·∫°i</h3>
        <form id="farm-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="farm-name">T√™n n√¥ng tr·∫°i *</label>
              <input type="text" id="farm-name" required/>
            </div>
            <div class="form-group">
              <label for="farm-owner">Ch·ªß n√¥ng tr·∫°i *</label>
              <input type="text" id="farm-owner" required/>
            </div>
            <div class="form-group">
              <label for="farm-area">Di·ªán t√≠ch (hecta) *</label>
              <input type="number" id="farm-area" step="0.1" required/>
            </div>
            <div class="form-group">
              <label for="farm-location">ƒê·ªãa ƒëi·ªÉm *</label>
              <input type="text" id="farm-location" required/>
            </div>
            <div class="form-group">
              <label for="farm-phone">S·ªë ƒëi·ªán tho·∫°i</label>
              <input type="tel" id="farm-phone"/>
            </div>
            <div class="form-group">
              <label for="farm-email">Email</label>
              <input type="email" id="farm-email"/>
            </div>
            <div class="form-group">
              <label for="farm-latitude">Vƒ© ƒë·ªô (latitude)</label>
              <input type="number" id="farm-latitude" step="0.000001" />
            </div>
            <div class="form-group">
              <label for="farm-longitude">Kinh ƒë·ªô (longitude)</label>
              <input type="number" id="farm-longitude" step="0.000001" />
            </div>
          </div>
          <div class="form-group">
            <label for="farm-status">Tr·∫°ng th√°i</label>
            <select id="farm-status">
              <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
              <option value="inactive">Ng∆∞ng ho·∫°t ƒë·ªông</option>
            </select>
          </div>
          <div class="form-group">
            <label for="farm-description">M√¥ t·∫£</label>
            <textarea id="farm-description" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary" id="farm-btn-text">T·∫°o n√¥ng tr·∫°i m·ªõi</button>
          <button type="button" class="btn" onclick="cancelFarmEdit()">H·ªßy</button>
        </form>
      </div>

      <div id="farm-message"></div>
      <div id="farm-loading" class="loading" style="display:none;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="farm-list" class="farm-list"></div>
    </div>

    <!-- Tab Qu·∫£n l√Ω C√¢y tr·ªìng -->
    <div id="crops" class="tab-content">
      <h2>Qu·∫£n l√Ω C√¢y tr·ªìng</h2>

      <div class="search-filter-section">
        <div class="search-filter-grid">
          <div class="search-input">
            <input type="text" id="crop-search" placeholder="T√¨m ki·∫øm c√¢y tr·ªìng..." onkeyup="searchCrops()">
          </div>
          <select id="crop-type-filter" onchange="filterCrops()">
            <option value="">T·∫•t c·∫£ lo·∫°i c√¢y</option>
            <option value="rau">Rau</option>
            <option value="cu">C·ªß</option>
            <option value="qua">Qu·∫£</option>
            <option value="ngucoc">Ng≈© c·ªëc</option>
            <option value="canhoa">C√¢y hoa</option>
            <option value="khac">Kh√°c</option>
          </select>
          <button class="btn btn-primary" onclick="toggleCropForm()">+ Th√™m c√¢y tr·ªìng</button>
        </div>
      </div>

      <div class="form-group">
        <label for="farm-selector">Ch·ªçn n√¥ng tr·∫°i *</label>
        <select id="farm-selector">
          <option value="">-- Ch·ªçn n√¥ng tr·∫°i --</option>
        </select>
      </div>

      <div id="crop-form-section" class="form-section" style="display: none;">
        <h3>Th√¥ng tin c√¢y tr·ªìng</h3>
        <form id="crop-form">
          <div class="form-grid">
            <div class="form-group">
              <label for="crop-name">T√™n c√¢y tr·ªìng *</label>
              <input type="text" id="crop-name" required/>
            </div>
            <div class="form-group">
              <label for="crop-type">Lo·∫°i c√¢y *</label>
              <select id="crop-type" required>
                <option value="">Ch·ªçn lo·∫°i c√¢y</option>
                <option value="rau">Rau</option>
                <option value="cu">C·ªß</option>
                <option value="qua">Qu·∫£</option>
                <option value="ngucoc">Ng≈© c·ªëc</option>
                <option value="canhoa">C√¢y hoa</option>
                <option value="khac">Kh√°c</option>
              </select>
            </div>
            <div class="form-group">
              <label for="crop-season">M√πa tr·ªìng *</label>
              <select id="crop-season" required>
                <option value="">Ch·ªçn m√πa tr·ªìng</option>
                <option value="xuan">Xu√¢n</option>
                <option value="ha">H·∫°</option>
                <option value="thu">Thu</option>
                <option value="dong">ƒê√¥ng</option>
                <option value="canam">C·∫£ nƒÉm</option>
              </select>
            </div>
            <div class="form-group">
              <label for="crop-growth-time">Th·ªùi gian sinh tr∆∞·ªüng (ng√†y)</label>
              <input type="number" id="crop-growth-time" min="1"/>
            </div>
            <div class="form-group">
              <label for="crop-planting-date">Ng√†y tr·ªìng</label>
              <input type="date" id="crop-planting-date"/>
            </div>
            <div class="form-group">
              <label for="crop-quantity">S·ªë l∆∞·ª£ng/Di·ªán t√≠ch</label>
              <input type="number" id="crop-quantity" step="0.1"/>
            </div>
          </div>
          <div class="form-group">
            <label for="crop-description">M√¥ t·∫£</label>
            <textarea id="crop-description" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary" id="crop-btn-text">T·∫°o c√¢y tr·ªìng m·ªõi</button>
          <button type="button" class="btn" onclick="cancelCropEdit()">H·ªßy</button>
        </form>
      </div>

      <div id="crop-message"></div>
      <div id="crop-loading" class="loading" style="display:none;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="crop-list" class="crop-list"></div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <h2>Th·ªëng k√™ v√† B√°o c√°o</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="avg-farm-area">0</h3>
          <p>Di·ªán t√≠ch trung b√¨nh (ha)</p>
        </div>
        <div class="stat-card">
          <h3 id="most-popular-crop">-</h3>
          <p>Lo·∫°i c√¢y ph·ªï bi·∫øn nh·∫•t</p>
        </div>
        <div class="stat-card">
          <h3 id="crops-per-farm">0</h3>
          <p>S·ªë c√¢y tr·ªìng/n√¥ng tr·∫°i</p>
        </div>
        <div class="stat-card">
          <h3 id="seasonal-distribution">-</h3>
          <p>Ph√¢n b·ªë theo m√πa</p>
        </div>
      </div>

      <div class="form-section">
        <h3>üìä Bi·ªÉu ƒë·ªì th·ªëng k√™</h3>
        <div id="charts-container">
          <canvas id="crop-chart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Container -->
  <div class="notifications" id="notifications-container"></div>

  <!-- Modal for confirmations -->
  <div id="confirmation-modal" class="modal">
    <div class="modal-content">
      <h3>X√°c nh·∫≠n</h3>
      <p id="confirmation-message"></p>
      <div style="margin-top: 20px;">
        <button class="btn btn-danger" id="confirm-btn">X√°c nh·∫≠n</button>
        <button class="btn" onclick="closeModal()">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- Firebase v√† Script logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      getDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      orderBy,
      query,
      serverTimestamp,
      where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6WyGsOeOlct2BcOeQSZ6ogo2aGUa_MyQ",
      authDomain: "nongnghiepxanh-f6689.firebaseapp.com",
      projectId: "nongnghiepxanh-f6689",
      storageBucket: "nongnghiepxanh-f6689.appspot.com",
      messagingSenderId: "846834085038",
      appId: "1:846834085038:web:cfac519e025896626d113f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let editingFarmId = null;
    let editingCropId = null;
    let selectedFarmId = null;
    let allFarms = [];
    let allCrops = [];

    // Global functions for tab management
    window.showTab = (tabName, event) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      switch(tabName) {
        case 'dashboard':
          loadDashboard();
          break;
        case 'farms':
          loadFarms();
          break;
        case 'crops':
          loadFarmSelector();
          break;
        case 'analytics':
          loadAnalytics();
          break;
      }
    };

    // Notification system
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notifications-container');
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
        </div>
      `;
      container.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }

    function showMessage(elementId, message, type = 'success') {
      const div = document.getElementById(elementId);
      div.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => div.innerHTML = '', 4000);
      
      // Also show as notification
      showNotification(message, type);
    }

    // Modal functions
    window.closeModal = () => {
      document.getElementById('confirmation-modal').classList.remove('active');
    };

    function showConfirmation(message, callback) {
      document.getElementById('confirmation-message').textContent = message;
      document.getElementById('confirm-btn').onclick = () => {
        callback();
        closeModal();
      };
      document.getElementById('confirmation-modal').classList.add('active');
    }

    // Toggle form functions
    window.toggleFarmForm = () => {
      const formSection = document.getElementById('farm-form-section');
      formSection.style.display = formSection.style.display === 'none' ? 'block' : 'none';
    };

    window.toggleCropForm = () => {
      const formSection = document.getElementById('crop-form-section');
      formSection.style.display = formSection.style.display === 'none' ? 'block' : 'none';
    };

    // Search and filter functions
    window.searchFarms = () => {
      const searchTerm = document.getElementById('farm-search').value.toLowerCase();
      const filteredFarms = allFarms.filter(farm => 
        farm.name.toLowerCase().includes(searchTerm) ||
        farm.owner.toLowerCase().includes(searchTerm) ||
        farm.location.toLowerCase().includes(searchTerm)
      );
      displayFarms(filteredFarms);
    };

    window.filterFarms = () => {
      const filterValue = document.getElementById('farm-filter').value;
      const filteredFarms = filterValue ? 
        allFarms.filter(farm => farm.status === filterValue) : 
        allFarms;
      displayFarms(filteredFarms);
    };

    window.searchCrops = () => {
      const searchTerm = document.getElementById('crop-search').value.toLowerCase();
      const filteredCrops = allCrops.filter(crop => 
        crop.name.toLowerCase().includes(searchTerm) ||
        crop.type.toLowerCase().includes(searchTerm)
      );
      displayCrops(filteredCrops);
    };

    window.filterCrops = () => {
      const filterValue = document.getElementById('crop-type-filter').value;
      const filteredCrops = filterValue ? 
        allCrops.filter(crop => crop.type === filterValue) : 
        allCrops;
      displayCrops(filteredCrops);
    };

    // Dashboard functions
    async function loadDashboard() {
      try {
        const farmsSnapshot = await getDocs(collection(db, 'farms'));
        const totalFarms = farmsSnapshot.size;
        const activeFarms = farmsSnapshot.docs.filter(doc => doc.data().status !== 'inactive').length;
        
        let totalArea = 0;
        let totalCrops = 0;
        
        for (let farmDoc of farmsSnapshot.docs) {
          const farmData = farmDoc.data();
          totalArea += farmData.area || 0;
          
          const cropsSnapshot = await getDocs(collection(db, 'farms', farmDoc.id, 'crops'));
          totalCrops += cropsSnapshot.size;
        }

        document.getElementById('total-farms').textContent = totalFarms;
        document.getElementById('total-crops').textContent = totalCrops;
        document.getElementById('total-area').textContent = totalArea.toFixed(1);
        document.getElementById('active-farms').textContent = activeFarms;
        
        // Update recent notifications
        updateRecentNotifications();
      } catch (error) {
        console.error('Error loading dashboard:', error);
        showNotification('L·ªói khi t·∫£i dashboard', 'error');
      }
    }

    function updateRecentNotifications() {
      const notifications = document.getElementById('recent-notifications');
      const currentDate = new Date().toLocaleDateString('vi-VN');
      
      notifications.innerHTML = `
        <div class="alert alert-info">
          <strong>üåü Ch√†o m·ª´ng!</strong> H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p v·ªõi nhi·ªÅu t√≠nh nƒÉng m·ªõi.
        </div>
        <div class="alert alert-success">
          <strong>üìÖ ${currentDate}</strong> H·ªá th·ªëng ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.
        </div>
      `;
    }

    // Farm management
    document.getElementById('farm-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const farmData = {
        name: document.getElementById('farm-name').value.trim(),
        owner: document.getElementById('farm-owner').value.trim(),
        area: parseFloat(document.getElementById('farm-area').value),
        location: document.getElementById('farm-location').value.trim(),
        phone: document.getElementById('farm-phone').value.trim(),
        email: document.getElementById('farm-email').value.trim(),
        status: document.getElementById('farm-status').value,
        description: document.getElementById('farm-description').value.trim(),
        updatedAt: serverTimestamp(),
        latitude: parseFloat(document.getElementById('farm-latitude').value) || null,
        longitude: parseFloat(document.getElementById('farm-longitude').value) || null,
      };

      if (!farmData.name || !farmData.owner || !farmData.area || !farmData.location) {
        showMessage('farm-message', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
        return;
      }

      try {
        if (editingFarmId) {
          await updateDoc(doc(db, 'farms', editingFarmId), farmData);
          showMessage('farm-message', 'C·∫≠p nh·∫≠t n√¥ng tr·∫°i th√†nh c√¥ng!');
          editingFarmId = null;
        } else {
          farmData.createdAt = serverTimestamp();
          await addDoc(collection(db, 'farms'), farmData);
          showMessage('farm-message', 'T·∫°o n√¥ng tr·∫°i m·ªõi th√†nh c√¥ng!');
        }
        
        document.getElementById('farm-form').reset();
        document.getElementById('farm-btn-text').textContent = 'T·∫°o n√¥ng tr·∫°i m·ªõi';
        document.getElementById('farm-form-section').style.display = 'none';
        loadFarms();
      } catch (error) {
        console.error('Error saving farm:', error);
        showMessage('farm-message', 'L·ªói khi l∆∞u th√¥ng tin n√¥ng tr·∫°i!', 'error');
      }
    });

    async function loadFarms() {
      document.getElementById('farm-loading').style.display = 'block';
      try {
        const q = query(collection(db, 'farms'), orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(q);
        
        allFarms = [];
        snapshot.forEach(docSnap => {
          const farmData = docSnap.data();
          allFarms.push({
            id: docSnap.id,
            ...farmData
          });
        });
        
        displayFarms(allFarms);
      } catch (error) {
        console.error('Error loading farms:', error);
        showMessage('farm-message', 'L·ªói khi t·∫£i danh s√°ch n√¥ng tr·∫°i!', 'error');
      } finally {
        document.getElementById('farm-loading').style.display = 'none';
      }
    }

    function displayFarms(farms) {
      const farmList = document.getElementById('farm-list');
      farmList.innerHTML = '';
      
      if (farms.length === 0) {
        farmList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Kh√¥ng t√¨m th·∫•y n√¥ng tr·∫°i n√†o.</p>';
        return;
      }

      farms.forEach(farm => {
        const div = document.createElement('div');
        div.className = 'farm-card';
        div.innerHTML = `
          <div class="card-header">
            <h3 class="card-title">üåæ ${farm.name}</h3>
            <span class="card-status ${farm.status === 'active' ? 'status-active' : 'status-inactive'}">
              ${farm.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Ng∆∞ng ho·∫°t ƒë·ªông'}
            </span>
          </div>
          <div class="card-info">
            <p><strong>Ch·ªß n√¥ng tr·∫°i:</strong> ${farm.owner}</p>
            <p><strong>Di·ªán t√≠ch:</strong> ${farm.area} ha</p>
            <p><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${farm.location}</p>
            ${farm.phone ? `<p><strong>ƒêi·ªán tho·∫°i:</strong> ${farm.phone}</p>` : ''}
            ${farm.email ? `<p><strong>Email:</strong> ${farm.email}</p>` : ''}
            ${farm.description ? `<p><strong>M√¥ t·∫£:</strong> ${farm.description}</p>` : ''}
          </div>
          <div class="card-actions">
            <button class="btn btn-primary" onclick="editFarm('${farm.id}')">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-success" onclick="viewFarmDetails('${farm.id}')">üëÅÔ∏è Xem</button>
            <button class="btn btn-danger" onclick="deleteFarm('${farm.id}')">üóëÔ∏è X√≥a</button>
          </div>
        `;
        farmList.appendChild(div);
      });
    }

    window.editFarm = async (id) => {
      try {
        const docRef = doc(db, 'farms', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const farm = docSnap.data();
          document.getElementById('farm-name').value = farm.name || '';
          document.getElementById('farm-owner').value = farm.owner || '';
          document.getElementById('farm-area').value = farm.area || '';
          document.getElementById('farm-location').value = farm.location || '';
          document.getElementById('farm-phone').value = farm.phone || '';
          document.getElementById('farm-email').value = farm.email || '';
          document.getElementById('farm-status').value = farm.status || 'active';
          document.getElementById('farm-description').value = farm.description || '';
          document.getElementById('farm-latitude').value = farm.latitude || '';
          document.getElementById('farm-longitude').value = farm.longitude || '';
          editingFarmId = id;
          document.getElementById('farm-btn-text').textContent = 'C·∫≠p nh·∫≠t n√¥ng tr·∫°i';
          document.getElementById('farm-form-section').style.display = 'block';
          
          // Scroll to form
          document.getElementById('farm-form-section').scrollIntoView({ behavior: 'smooth' });
        }
      } catch (error) {
        console.error('Error loading farm for edit:', error);
        showNotification('L·ªói khi t·∫£i th√¥ng tin n√¥ng tr·∫°i!', 'error');
      }
    };

    window.viewFarmDetails = async (id) => {
      try {
        const docRef = doc(db, 'farms', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const farm = docSnap.data();
          const cropsSnapshot = await getDocs(collection(db, 'farms', id, 'crops'));
          const cropsCount = cropsSnapshot.size;
          
          alert(`Chi ti·∫øt n√¥ng tr·∫°i: ${farm.name}
Ch·ªß n√¥ng tr·∫°i: ${farm.owner}
Di·ªán t√≠ch: ${farm.area} ha
ƒê·ªãa ƒëi·ªÉm: ${farm.location}
S·ªë lo·∫°i c√¢y tr·ªìng: ${cropsCount}
Tr·∫°ng th√°i: ${farm.status === 'active' ? 'ƒêang ho·∫°t ƒë·ªông' : 'Ng∆∞ng ho·∫°t ƒë·ªông'}`);
        }
      } catch (error) {
        console.error('Error loading farm details:', error);
        showNotification('L·ªói khi t·∫£i chi ti·∫øt n√¥ng tr·∫°i!', 'error');
      }
    };

    window.deleteFarm = (id) => {
      showConfirmation('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n√¥ng tr·∫°i n√†y? T·∫•t c·∫£ c√¢y tr·ªìng trong n√¥ng tr·∫°i c≈©ng s·∫Ω b·ªã x√≥a.', async () => {
        try {
          await deleteDoc(doc(db, 'farms', id));
          showMessage('farm-message', 'ƒê√£ x√≥a n√¥ng tr·∫°i th√†nh c√¥ng!');
          loadFarms();
        } catch (error) {
          console.error('Error deleting farm:', error);
          showMessage('farm-message', 'L·ªói khi x√≥a n√¥ng tr·∫°i!', 'error');
        }
      });
    };

    window.cancelFarmEdit = () => {
      editingFarmId = null;
      document.getElementById('farm-form').reset();
      document.getElementById('farm-btn-text').textContent = 'T·∫°o n√¥ng tr·∫°i m·ªõi';
      document.getElementById('farm-form-section').style.display = 'none';
    };

    // Farm selector for crops
    async function loadFarmSelector() {
      try {
        const farmSelector = document.getElementById('farm-selector');
        farmSelector.innerHTML = '<option value="">-- Ch·ªçn n√¥ng tr·∫°i --</option>';
        
        const q = query(collection(db, 'farms'), orderBy('name'));
        const snapshot = await getDocs(q);
        
        snapshot.forEach(docSnap => {
          const farm = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = farm.name;
          farmSelector.appendChild(option);
        });
        
        farmSelector.addEventListener('change', (e) => {
          selectedFarmId = e.target.value;
          loadCrops();
        });
      } catch (error) {
        console.error('Error loading farm selector:', error);
        showNotification('L·ªói khi t·∫£i danh s√°ch n√¥ng tr·∫°i!', 'error');
      }
    }

    // Crop management
    document.getElementById('crop-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!selectedFarmId) {
        showMessage('crop-message', 'Vui l√≤ng ch·ªçn n√¥ng tr·∫°i tr∆∞·ªõc!', 'error');
        return;
      }

      const cropData = {
        name: document.getElementById('crop-name').value.trim(),
        type: document.getElementById('crop-type').value,
        season: document.getElementById('crop-season').value,
        growthTime: parseInt(document.getElementById('crop-growth-time').value) || null,
        plantingDate: document.getElementById('crop-planting-date').value,
        quantity: parseFloat(document.getElementById('crop-quantity').value) || null,
        description: document.getElementById('crop-description').value.trim(),
        updatedAt: serverTimestamp()
      };

      if (!cropData.name || !cropData.type || !cropData.season) {
        showMessage('crop-message', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!', 'error');
        return;
      }

      try {
        if (editingCropId) {
          await updateDoc(doc(db, 'farms', selectedFarmId, 'crops', editingCropId), cropData);
          showMessage('crop-message', 'C·∫≠p nh·∫≠t c√¢y tr·ªìng th√†nh c√¥ng!');
          editingCropId = null;
        } else {
          cropData.createdAt = serverTimestamp();
          await addDoc(collection(db, 'farms', selectedFarmId, 'crops'), cropData);
          showMessage('crop-message', 'T·∫°o c√¢y tr·ªìng m·ªõi th√†nh c√¥ng!');
        }
        
        document.getElementById('crop-form').reset();
        document.getElementById('crop-btn-text').textContent = 'T·∫°o c√¢y tr·ªìng m·ªõi';
        document.getElementById('crop-form-section').style.display = 'none';
        loadCrops();
      } catch (error) {
        console.error('Error saving crop:', error);
        showMessage('crop-message', 'L·ªói khi l∆∞u th√¥ng tin c√¢y tr·ªìng!', 'error');
      }
    });

    async function loadCrops() {
      const cropList = document.getElementById('crop-list');
      cropList.innerHTML = '';
      
      if (!selectedFarmId) {
        cropList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ch·ªçn n√¥ng tr·∫°i ƒë·ªÉ xem c√¢y tr·ªìng.</p>';
        return;
      }

      document.getElementById('crop-loading').style.display = 'block';
      
      try {
        const q = query(collection(db, 'farms', selectedFarmId, 'crops'), orderBy('createdAt', 'desc'));
        const snapshot = await getDocs(q);
        
        allCrops = [];
        snapshot.forEach(docSnap => {
          const cropData = docSnap.data();
          allCrops.push({
            id: docSnap.id,
            ...cropData
          });
        });
        
        displayCrops(allCrops);
      } catch (error) {
        console.error('Error loading crops:', error);
        showMessage('crop-message', 'L·ªói khi t·∫£i danh s√°ch c√¢y tr·ªìng!', 'error');
      } finally {
        document.getElementById('crop-loading').style.display = 'none';
      }
    }

    function displayCrops(crops) {
      const cropList = document.getElementById('crop-list');
      cropList.innerHTML = '';
      
      if (crops.length === 0) {
        cropList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ch∆∞a c√≥ c√¢y tr·ªìng n√†o.</p>';
        return;
      }

      crops.forEach(crop => {
        const div = document.createElement('div');
        div.className = 'crop-card';
        
        // Calculate progress if planting date is available
        let progressHTML = '';
        if (crop.plantingDate && crop.growthTime) {
          const plantingDate = new Date(crop.plantingDate);
          const currentDate = new Date();
          const daysPassed = Math.floor((currentDate - plantingDate) / (1000 * 60 * 60 * 24));
          const progress = Math.min(Math.max((daysPassed / crop.growthTime) * 100, 0), 100);
          
          progressHTML = `
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <p><strong>Ti·∫øn ƒë·ªô sinh tr∆∞·ªüng:</strong> ${progress.toFixed(1)}% (${daysPassed}/${crop.growthTime} ng√†y)</p>
          `;
        }
        
        div.innerHTML = `
          <div class="card-header">
            <h3 class="card-title">üå± ${crop.name}</h3>
            <span class="card-status status-active">${getTypeDisplayName(crop.type)}</span>
          </div>
          <div class="card-info">
            <p><strong>Lo·∫°i c√¢y:</strong> ${getTypeDisplayName(crop.type)}</p>
            <p><strong>M√πa tr·ªìng:</strong> ${getSeasonDisplayName(crop.season)}</p>
            ${crop.growthTime ? `<p><strong>Th·ªùi gian sinh tr∆∞·ªüng:</strong> ${crop.growthTime} ng√†y</p>` : ''}
            ${crop.plantingDate ? `<p><strong>Ng√†y tr·ªìng:</strong> ${new Date(crop.plantingDate).toLocaleDateString('vi-VN')}</p>` : ''}
            ${crop.quantity ? `<p><strong>S·ªë l∆∞·ª£ng/Di·ªán t√≠ch:</strong> ${crop.quantity}</p>` : ''}
            ${crop.description ? `<p><strong>M√¥ t·∫£:</strong> ${crop.description}</p>` : ''}
            ${progressHTML}
          </div>
          <div class="card-actions">
            <button class="btn btn-primary" onclick="editCrop('${crop.id}')">‚úèÔ∏è S·ª≠a</button>
            <button class="btn btn-success" onclick="viewCropDetails('${crop.id}')">üëÅÔ∏è Xem</button>
            <button class="btn btn-danger" onclick="deleteCrop('${crop.id}')">üóëÔ∏è X√≥a</button>
          </div>
        `;
        cropList.appendChild(div);
      });
    }

    function getTypeDisplayName(type) {
      const types = {
        'rau': 'Rau',
        'cu': 'C·ªß',
        'qua': 'Qu·∫£',
        'ngucoc': 'Ng≈© c·ªëc',
        'canhoa': 'C√¢y hoa',
        'khac': 'Kh√°c'
      };
      return types[type] || type;
    }

    function getSeasonDisplayName(season) {
      const seasons = {
        'xuan': 'Xu√¢n',
        'ha': 'H·∫°',
        'thu': 'Thu',
        'dong': 'ƒê√¥ng',
        'canam': 'C·∫£ nƒÉm'
      };
      return seasons[season] || season;
    }

    window.editCrop = async (id) => {
      try {
        const docRef = doc(db, 'farms', selectedFarmId, 'crops', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const crop = docSnap.data();
          document.getElementById('crop-name').value = crop.name || '';
          document.getElementById('crop-type').value = crop.type || '';
          document.getElementById('crop-season').value = crop.season || '';
          document.getElementById('crop-growth-time').value = crop.growthTime || '';
          document.getElementById('crop-planting-date').value = crop.plantingDate || '';
          document.getElementById('crop-quantity').value = crop.quantity || '';
          document.getElementById('crop-description').value = crop.description || '';
          
          editingCropId = id;
          document.getElementById('crop-btn-text').textContent = 'C·∫≠p nh·∫≠t c√¢y tr·ªìng';
          document.getElementById('crop-form-section').style.display = 'block';
          
          // Scroll to form
          document.getElementById('crop-form-section').scrollIntoView({ behavior: 'smooth' });
        }
      } catch (error) {
        console.error('Error loading crop for edit:', error);
        showNotification('L·ªói khi t·∫£i th√¥ng tin c√¢y tr·ªìng!', 'error');
      }
    };

    window.viewCropDetails = async (id) => {
      try {
        const docRef = doc(db, 'farms', selectedFarmId, 'crops', id);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          const crop = docSnap.data();
          let details = `Chi ti·∫øt c√¢y tr·ªìng: ${crop.name}
Lo·∫°i c√¢y: ${getTypeDisplayName(crop.type)}
M√πa tr·ªìng: ${getSeasonDisplayName(crop.season)}`;
          
          if (crop.growthTime) details += `\nTh·ªùi gian sinh tr∆∞·ªüng: ${crop.growthTime} ng√†y`;
          if (crop.plantingDate) details += `\nNg√†y tr·ªìng: ${new Date(crop.plantingDate).toLocaleDateString('vi-VN')}`;
          if (crop.quantity) details += `\nS·ªë l∆∞·ª£ng: ${crop.quantity}`;
          if (crop.description) details += `\nM√¥ t·∫£: ${crop.description}`;
          
          alert(details);
        }
      } catch (error) {
        console.error('Error loading crop details:', error);
        showNotification('L·ªói khi t·∫£i chi ti·∫øt c√¢y tr·ªìng!', 'error');
      }
    };

    window.deleteCrop = (id) => {
      showConfirmation('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢y tr·ªìng n√†y?', async () => {
        try {
          await deleteDoc(doc(db, 'farms', selectedFarmId, 'crops', id));
          showMessage('crop-message', 'ƒê√£ x√≥a c√¢y tr·ªìng th√†nh c√¥ng!');
          loadCrops();
        } catch (error) {
          console.error('Error deleting crop:', error);
          showMessage('crop-message', 'L·ªói khi x√≥a c√¢y tr·ªìng!', 'error');
        }
      });
    };

    window.cancelCropEdit = () => {
      editingCropId = null;
      document.getElementById('crop-form').reset();
      document.getElementById('crop-btn-text').textContent = 'T·∫°o c√¢y tr·ªìng m·ªõi';
      document.getElementById('crop-form-section').style.display = 'none';
    };

    // Analytics
    async function loadAnalytics() {
      try {
        const farmsSnapshot = await getDocs(collection(db, 'farms'));
        const totalFarms = farmsSnapshot.size;
        let totalArea = 0;
        let allCropsData = [];
        
        for (let farmDoc of farmsSnapshot.docs) {
          const farmData = farmDoc.data();
          totalArea += farmData.area || 0;
          
          const cropsSnapshot = await getDocs(collection(db, 'farms', farmDoc.id, 'crops'));
          cropsSnapshot.forEach(cropDoc => {
            allCropsData.push(cropDoc.data());
          });
        }
        
        // Calculate analytics
        const avgFarmArea = totalFarms > 0 ? (totalArea / totalFarms).toFixed(1) : 0;
        const cropsPerFarm = totalFarms > 0 ? (allCropsData.length / totalFarms).toFixed(1) : 0;
        
        // Most popular crop type
        const cropTypeCounts = {};
        allCropsData.forEach(crop => {
          cropTypeCounts[crop.type] = (cropTypeCounts[crop.type] || 0) + 1;
        });
        
        const mostPopularCrop = Object.keys(cropTypeCounts).reduce((a, b) => 
          cropTypeCounts[a] > cropTypeCounts[b] ? a : b, 'Ch∆∞a c√≥ d·ªØ li·ªáu'
        );
        
        // Seasonal distribution
        const seasonCounts = {};
        allCropsData.forEach(crop => {
          seasonCounts[crop.season] = (seasonCounts[crop.season] || 0) + 1;
        });
        
        const mostPopularSeason = Object.keys(seasonCounts).reduce((a, b) => 
          seasonCounts[a] > seasonCounts[b] ? a : b, 'Ch∆∞a c√≥ d·ªØ li·ªáu'
        );
        
        // Update UI
        document.getElementById('avg-farm-area').textContent = avgFarmArea;
        document.getElementById('most-popular-crop').textContent = getTypeDisplayName(mostPopularCrop);
        document.getElementById('crops-per-farm').textContent = cropsPerFarm;
        document.getElementById('seasonal-distribution').textContent = getSeasonDisplayName(mostPopularSeason);
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu th·ªëng k√™!', 'error');
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      showNotification('Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Smart Farm Management System!', 'success');
    });
  </script>
</body>
</html>